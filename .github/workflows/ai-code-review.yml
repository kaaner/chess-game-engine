name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR files and diff
        id: pr-info
        run: |
          # Get the diff
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          
          # Save to file for easier handling
          echo "$DIFF" > pr_diff.txt
          
          # Get changed files
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with AI
        id: ai-review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Install jq for JSON processing
          sudo apt-get update && sudo apt-get install -y jq
          
          # Read the diff
          DIFF=$(cat pr_diff.txt)
          
          # Prepare the prompt
          PROMPT="You are an expert code reviewer. Review the following pull request and provide:
          
          1. **Summary**: Brief overview of changes
          2. **Code Quality**: Assessment of code quality and adherence to best practices
          3. **Potential Issues**: Any bugs, security concerns, or performance issues
          4. **Suggestions**: Specific improvement recommendations
          5. **Approval Status**: APPROVE, REQUEST_CHANGES, or COMMENT
          
          PR Title: ${PR_TITLE}
          PR Description: ${PR_BODY}
          
          Changes:
          \`\`\`diff
          ${DIFF}
          \`\`\`
          
          Provide a structured, actionable review in markdown format."
          
          # Call OpenAI API
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -d "{
              \"model\": \"gpt-4\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"You are a senior software engineer reviewing code. Be constructive, specific, and helpful.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$PROMPT" | jq -Rs .)
                }
              ],
              \"temperature\": 0.3,
              \"max_tokens\": 2000
            }")
          
          # Extract the review content
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          
          # Save to output
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment
        uses: actions/github-script@v7
        env:
          REVIEW_CONTENT: ${{ steps.ai-review.outputs.review }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = process.env.REVIEW_CONTENT;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– AI Code Review
              
${review}

---
*ðŸ” Automated review powered by AI | Generated at ${new Date().toISOString()}*
*Note: This is an automated review. Human review is still recommended.*`
            });

      - name: Add Review Labels
        uses: actions/github-script@v7
        env:
          REVIEW_CONTENT: ${{ steps.ai-review.outputs.review }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = process.env.REVIEW_CONTENT.toLowerCase();
            const labels = [];
            
            if (review.includes('security')) {
              labels.push('security-review');
            }
            if (review.includes('performance')) {
              labels.push('performance');
            }
            if (review.includes('bug')) {
              labels.push('potential-bug');
            }
            if (review.includes('approve')) {
              labels.push('ai-approved');
            }
            if (review.includes('request_changes')) {
              labels.push('ai-changes-requested');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }
